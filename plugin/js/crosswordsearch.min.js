/*
crosswordsearch Wordpress plugin v1.1.0
Copyright Claus Colloseus 2014 for RadiJojo.de

This program is free software: Redistribution and use, with or
without modification, are permitted provided that the following
conditions are met:
 * If you redistribute this code, either as source code or in
   minimized, compacted or obfuscated form, you must retain the
   above copyright notice, this list of conditions and the
   following disclaimer.
 * If you modify this code, distributions must not misrepresent
   the origin of those parts of the code that remain unchanged,
   and you must retain the above copyright notice and the following
   disclaimer.
 * If you modify this code, distributions must include a license
   which is compatible to the terms and conditions of this license.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*/
var customSelectElement=angular.module("customSelectElement",[]);customSelectElement.directive("cseDefault",function(){return{scope:{value:"="},template:function(a,b){return"{{"+(b.cseDefault||"value.value || value")+"}}"}}}),customSelectElement.directive("cseOption",["$compile",function(a){return{scope:{value:"="},link:function(b,c,d){b.select=function(a){b.$emit("cseSelect",d.name,a)},d.$observe("value",function(){var e;angular.isObject(b.value)&&b.value.group?(e='<dl cse-select="'+d.name+'.sub" cse-model="head" cse-options="value.group" is-group ',angular.isDefined(d.expr)?e+='display="'+d.expr+'"':e+='template="'+d.templ+'"',angular.isDefined(d.isMenu)&&(e+=' is-menu="'+b.value.menu+'"'),e+="></dl>",c.html(e)):(e="<div ng-click=",angular.isObject(b.value)&&angular.isDefined(b.value.value)?e+='"select(value.value)" ':e+='"select(value)" ',e+=d.templ,angular.isDefined(d.expr)&&(e+='="'+d.expr+'"'),e+=' value="value"></div>',c.html(e)),a(c.contents())(b)})}}}]),customSelectElement.directive("cseSelect",["$document","$timeout",function(a,b){return{restrict:"A",scope:{options:"=cseOptions",model:"=cseModel"},link:function(c,d,e){function f(b){var e=angular.element(b.target);do{if(g(e,d))return;e=e.parent()}while(e.length&&!g(a,e));c.$apply("visible = false")}function g(a,b){return a[0]===b[0]}var h;d.addClass("cse select"),c.isDefined=angular.isDefined,angular.isDefined(e.isMenu)?(c.model=e.isMenu,c.setModel=!1):c.setModel=!0,c.visible=!1,c.$watch("visible",function(b){b?a.bind("click",f):a.unbind("click",f)}),c.hideLeave=function(){h=b(function(){c.visible=!1},200)},c.showEnter=function(){c.visible=!0,h&&b.cancel(h)},d.on("$destroy",function(){a.unbind("click",f),h&&b.cancel(h)}),c.$on("cseSelect",function(a,b,d){c.visible=!1,c.setModel&&(c.model=d)})},template:function(a,b){var c="cse-default",d=!1;angular.isDefined(b.template)?c=b.template:angular.isDefined(b.display)&&(d=!0);var e="<dt ";return angular.isDefined(b.isGroup)?e+='ng-mouseenter="showEnter()" ng-mouseleave="hideLeave()"':e+='ng-click="visible=!visible"',e+=' ng-show="isDefined(model)" '+c,d&&(e+='="'+b.display+'"'),e+=' value="model" is-current></dt><dd',angular.isDefined(b.isGroup)&&(e+=' ng-mouseenter="showEnter()" ng-mouseleave="hideLeave()"'),e+=' ng-show="visible"><ul><li ng-repeat="opt in options | orderBy:\'order\'" cse-option name="'+b.cseSelect+'" model="'+b.cseModel+'" value="opt" templ="'+c+'"',d&&(e+=' expr="'+b.display+'"'),angular.isDefined(b.isMenu)&&(e+=" is-menu"),e+="></li></ul></dd>"}}}]);var crwApp=angular.module("crwApp",["ngRoute","customSelectElement"]);crwApp.constant("nonces",{}),crwApp.factory("ajaxFactory",["$http","$q","nonces",function(a,b,c){var d=0;a.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded";var e={transformRequest:jQuery.param,method:"POST",url:crwBasics.ajaxUrl};jQuery(document).on("heartbeat-tick",function(a,b){!1===b["wp-auth-check"]&&Object.keys(c).forEach(function(a){delete c[a]})});var f=function(a){return a.heartbeat?b.reject(a):b.reject({error:"server error",debug:["status "+a.status]})},g=function(a,d){var e=!1;return"object"!=typeof a.data?e={error:"malformed request"}:a.data.error&&(e=a.data),e?b.reject(e):(a.data.nonce&&(c[d]=a.data.nonce),a.data)},h=function(b,d){var f=angular.extend({_crwnonce:c[d]},b),g=angular.extend({data:f},e);return a(g)};return{getId:function(){return d++},setNonce:function(a,b){c[b]=a},http:function(a,d){return c[d]?h(a,d).then(function(a){return g(a,d)},f):b.reject({heartbeat:!0})}}}]),crwApp.filter("localeNumber",function(){var a,b=(String.fromCharCode(8238),String.fromCharCode(8236),function(b){return String.fromCharCode(b.charCodeAt(0)+a)});return function(c){switch(crwBasics.numerals){case"arab":return a=1584,c.toString(10).replace(/[0-9]/g,b);case"arabext":return a=1728,c.toString(10).replace(/[0-9]/g,b);default:return c}}}),crwApp.directive("crwInteger",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.unshift(function(a){if(b.prop("disabled"))return a;var e=parseInt(a,10);return isNaN(e)||e<c.min||e.toString()!==a?void d.$setValidity(c.crwInteger,!1):(d.$setValidity(c.crwInteger,!0),e)})}}}),crwApp.directive("crwBindTrusted",["$sce",function(a){return{link:function(a,b,c){a.$watch(c.crwBindTrusted,function(a){b.html(a)})}}}]),crwApp.factory("basics",function(){var a=0,b=Object.keys(crwBasics.letterDist).reduce(function(b,c){var d=crwBasics.letterDist[c];a+=d;for(var e=0;e<d;e++)b.push(c);return b},[]);return{colors:["black","red","green","blue","orange","violet","aqua"],textIsLTR:"rtl"!==crwBasics.textDirection,fieldSize:crwBasics.dimensions.field+crwBasics.dimensions.fieldBorder,fieldShift:crwBasics.dimensions.fieldBorder/2,handleWidth:crwBasics.dimensions.handleInside+crwBasics.dimensions.handleOutside,handleOffset:crwBasics.dimensions.handleInside,randomColor:function(a){var b;do{b=this.colors[Math.floor(7*Math.random())]}while(b===a);return b},randomLetter:function(){var c=Math.floor(Math.random()*a);return b[c]},letterRegEx:new RegExp("^"+crwBasics.letterRegEx+"$"),normalizeLetter:function(a){return crwBasics.casesensitive||(a=a.toUpperCase()),crwBasics.accentMap&&Object.keys(crwBasics.accentMap).forEach(function(b){crwBasics.accentMap[b].indexOf(a)>-1&&(a=b)}),a},directionMapping:{"down-right":{end:"up-left",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-left":{end:"down-right",middle:"diagonal-down",left:"corner-up-right",right:"corner-down-left"},"up-right":{end:"down-left",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},"down-left":{end:"up-right",middle:"diagonal-up",left:"corner-down-right",right:"corner-up-left"},down:{end:"up",middle:"vertical"},up:{end:"down",middle:"vertical"},right:{end:"left",middle:"horizontal"},left:{end:"right",middle:"horizontal"}},localize:function(a){return crwBasics.locale[a]||a}}}),crwApp.factory("crosswordFactory",["basics","ajaxFactory",function(a,b){function c(){function c(a){return h=a.default_level,i=a.maximum_level,j=a.namesList,angular.isObject(a.crossword)?(angular.extend(g,a.crossword),o("sol")&&(g.solution=angular.copy(g.words))):n(),m.words=0,m.solution=0,angular.forEach(g.words,function(a){m.words++,r(a)}),!0}var d=b.getId(),e="crossword"+d,f="edit"+d,g={},h=1,i=3,j=[],k="",l=!1,m={words:0,solution:0},n=function(){angular.extend(g,{name:"",description:"",author:"",size:{width:10,height:10},table:[],words:{},solution:{},level:h}),s(g.size.height,!1)},o=function(a){switch(a){case"dir":return!(1&g.level);case"sol":return!(2&g.level)}},p=function(a,b){return{x:a,y:b,word:g.table[b][a]}},q=function(a){var b,c=a.start,d=a.stop,e=d.x-c.x,f=d.y-c.y,g=e<0||0===e&&f<0;if(a.fields=[],e*f>0)for(a.direction=g?"up-left":"down-right",b=0;Math.abs(b)<=Math.abs(d.x-c.x);g?b--:b++)a.fields.push(p(c.x+b,c.y+b));else if(e*f<0)for(a.direction=g?"down-left":"up-right",b=0;Math.abs(b)<=Math.abs(d.x-c.x);g?b--:b++)a.fields.push(p(c.x+b,c.y-b));else if(0===e&&0===f)a.direction="origin",a.fields.push(p(c.x,c.y));else if(0===e)for(a.direction=g?"up":"down",b=0;Math.abs(b)<=Math.abs(d.y-c.y);g?b--:b++)a.fields.push(p(c.x,c.y+b));else for(a.direction=g?"left":"right",b=0;Math.abs(b)<=Math.abs(d.x-c.x);g?b--:b++)a.fields.push(p(c.x+b,c.y))},r=function(a){var b=!1;return angular.forEach(g.words,function(c){angular.equals(c.start,a.start)&&angular.equals(c.stop,a.stop)&&c.ID!==a.ID&&(b=!0)}),!b&&(q(a),g.words[a.ID]=a)},s=function(a,b){if(a>0)for(var c=0;c<a;c++){var d=[];t(d,g.size.width,!1),b?g.table.unshift(d):g.table.push(d)}else g.table.splice(b?0:g.table.length+a,-a);b&&angular.forEach(g.words,function(b){b.start={x:b.start.x,y:b.start.y+a},b.stop={x:b.stop.x,y:b.stop.y+a}})},t=function(a,b,c){if(b>0)for(var d=0;d<b;d++){var e={letter:null};c?a.unshift(e):a.push(e)}else a.splice(c?0:a.length+b,-b)},u=function(a,b){for(var c=0;c<g.table.length;c++)t(g.table[c],a,b);b&&angular.forEach(g.words,function(b){b.start={x:b.start.x+a,y:b.start.y},b.stop={x:b.stop.x+a,y:b.stop.y}})},v=function(a){angular.forEach(g.table,function(b,c){angular.forEach(b,function(b,d){a.call(b,c,d)})})};this.getCrosswordData=function(){return g},this.getNamesList=function(){return j},this.getLevelList=function(){for(var a=[],b=0;b<=i;b++)a.push(b);return a},this.setProject=function(a,c,d,g){k=a,l=g,c&&b.setNonce(c,e),d&&b.setNonce(d,f)},this.loadDefault=n,this.loadCrosswordData=function(a){return b.http({action:"get_crossword",project:k,name:a,restricted:l+0},e).then(c)},this.getCount=function(){return m},this.saveCrosswordData=function(a,c,d,e){g.solution={};var h={action:"save_crossword",method:c,project:k,restricted:l+0,crossword:angular.toJson(g),username:d,password:e};return"update"===c?(h.old_name=a,h.name=g.name):h.name=a,b.http(h,f).then(function(a){return j=a.namesList,!0})},this.submitSolution=function(a,c,d){return b.http({action:"submit_solution",project:k,name:g.name,time:a,solved:m.solution,total:m.words,username:c,password:d},e).then(function(a){return a.submitted.toString()})},this.getHighId=function(){return Object.keys(g.words).reduce(function(a,b){return Math.max(a,g.words[b].ID)},0)},this.randomColor=function(){var b=this.getHighId();return a.randomColor(b>0?g.words[b].color:void 0)},this.deleteWord=function(a,b){g[b][a]&&delete g[b][a]},this.randomizeEmptyFields=function(){v(function(){this.letter||(this.letter=a.randomLetter())})},this.emptyAllFields=function(){v(function(){this.letter=null})},this.setWord=r,this.getLevelRestriction=o,this.probeWord=function(a){var b=a;return q(a),b.solved=!1,angular.forEach(g.words,function(a){angular.equals(a.start,b.start)&&angular.equals(a.stop,b.stop)&&(a.solved?b.solved=null:(b=a,a.solved=!0))}),b.markingId=a.ID,g.solution[b.ID]=b},this.testWordBoundaries=function(a,b){var c,d=[];switch(a){case"left":c=function(a){return Math.min(a.start.x,a.stop.x)<b};break;case"right":c=function(a){return Math.max(a.start.x,a.stop.x)>=g.size.width+b};break;case"top":c=function(a){return Math.min(a.start.y,a.stop.y)<b};break;case"bottom":c=function(a){return Math.max(a.start.y,a.stop.y)>=g.size.height+b}}return angular.forEach(g.words,function(a,b){c(a)&&d.push(parseInt(b,10))}),d},this.testDirection=function(){var b=a.textIsLTR?"right":"left",c=[];return angular.forEach(g.words,function(a,d){a.direction!==b&&"down"!==a.direction&&c.push(parseInt(d,10))}),c},this.changeSize=function(a,b,c){c.forEach(function(a){this.deleteWord(a,"words")},this);var d=angular.copy(g.size);switch(a){case"left":u(-b,!0),d.width-=b;break;case"right":u(b,!1),d.width+=b;break;case"top":s(-b,!0),d.height-=b;break;case"bottom":s(b,!1),d.height+=b}g.size=d}}return{getCrw:function(){return new c}}}]),crwApp.directive("crwHelpFollow",["$document",function(a){return{link:function(b,c,d){var e={},f=a.find(".contextual-help-tabs li, .help-tab-content");e.capabilities=f.filter("[id*=crw-help-tab-options]"),e.editor=f.filter("[id*=crw-help-tab-projects]"),e.review=f.filter("[id*=crw-help-tab-review]"),b.$watch("activeTab",function(a){var b=/(capabilities|editor|review)/.exec(a)[0];angular.forEach(e,function(a,c){c===b?a.addClass("active").filter("[id*=tab-panel]").attr("style",null):a.removeClass("active").filter("[id*=tab-panel]").css("display","none")})})}}}]),crwApp.controller("AdminController",["$scope","$location","qStore","ajaxFactory","crosswordFactory",function(a,b,c,d,e){a.crw=e.getCrw(),a.immediateStore=c.addStore(),a.setActive=function(a){b.path(a)},a.$on("$locationChangeStart",function(){a.activeTab=b.path()}),a.prepare=function(c,e){d.setNonce(e,"settings"),!a.activeTab&&/^\/(capabilities|editor|review)/.test(b.path())?a.activeTab=b.path():(a.activeTab=c,a.setActive(c))},a.setError=function(c){c?c.heartbeat?b.path(""):a.globalError=c:a.globalError=null}}]),crwApp.controller("OptionsController",["$scope","ajaxFactory",function(a,b){var c="options",d=function(b){a.capsEdit.$setPristine(),a.dimEdit&&a.dimEdit.$setPristine(),a.submissions.$setPristine(),a.setError(!1),a.capabilities=b.capabilities,a.dimensions=b.dimensions,a.subscribers=b.subscribers};a.update=function(e){var f={action:"update_crw_"+e};f[e]=angular.toJson(a[e]),b.http(f,c).then(d,a.setError)},a.prepare=function(e){b.setNonce(e,c),b.http({action:"get_crw_capabilities"},c).then(d,a.setError)}}]),crwApp.controller("EditorController",["$scope","$filter","ajaxFactory",function(a,b,c){var d="editors";a.levelList=function(b){var c,d,e=[];"default"===b?(c=0,d=a.currentProject.maximum_level):(c=Math.max(a.currentProject.default_level,a.currentProject.used_level),d=3);for(var f=c;f<=d;f++)e.push(f);return e},a.getProjectList=function(b){var c=[];return a.admin.projects.forEach(function(a){a.name!==b&&c.push(a.name)}),c},a.currentEditors=[];var e=function(c,d){a.admin=c,a.admin.projects.forEach(function(a){a.pristine=!0}),a.selectedProject=d?a.admin.projects.filter(function(a){return a.name===d})[0]:b("orderBy")(a.admin.projects,"name")[0],g(),a.editorsPristine=!0};a.$watch("projectMod.$pristine",function(b){var c=!0;["name","defaultL","maximumL"].forEach(function(b){c&=a.projectMod[b].$pristine}),!b&&c&&a.projectMod.$setPristine()}),a.addProject=function(){a.selectedProject=null};var f={name:"",default_level:1,maximum_level:3,used_level:0,editors:[]};a.currentProject=angular.copy(f),a.$watch("selectedProject",function(b){b?(a.currentProject=angular.copy(b),a.currentEditors=angular.copy(b.editors)):(a.currentProject=angular.copy(f),a.currentEditors=[]),a.projectMod.$setPristine(),a.editorsPristine=!0,a.setError(!1)}),a.abortProject=function(){a.selectedProject||(a.selectedProject=b("orderBy")(a.admin.projects,"name")[0]),a.currentProject=angular.copy(a.selectedProject),a.projectMod.$setPristine(),a.setError(!1)},a.saveProject=function(){c.http({action:"save_project",method:a.selectedProject?"update":"add",project:a.selectedProject?a.selectedProject.name:void 0,new_name:a.currentProject.name,default_level:a.currentProject.default_level,maximum_level:a.currentProject.maximum_level},d).then(function(b){e(b,a.currentProject.name)},a.setError)},a.deleteProject=function(){var b={which:"remove_project",project:a.selectedProject.name};a.immediateStore.newPromise("actionConfirmation",b).then(function(){c.http({action:"save_project",method:"remove",project:a.selectedProject.name},d).then(e)},a.setError)},a.filtered_users=[];var g=function(){a.admin&&(a.filtered_users=a.admin.all_users.filter(function(b){return a.currentEditors.indexOf(b.user_id)<0}),a.currentEditors.indexOf(a.selectedEditor)<0&&(a.selectedEditor=b("orderBy")(a.currentEditors,a.getUserName)[0]),a.filtered_users.indexOf(a.selectedUser)<0&&(a.selectedUser=b("orderBy")(a.filtered_users,"user_name")[0]),a.setError(!1))};a.$watchCollection("currentEditors",g);var h=function(b){a.currentEditors.push(b.user_id)},i=function(b){return a.admin.all_users.filter(function(a){return a.user_id===b})[0]};a.getUserName=function(a){return i(a).user_name},a.addAll=function(){a.filtered_users.forEach(h),a.editorsPristine=!1},a.addOne=function(){var b=a.selectedUser.user_id;h(a.selectedUser),a.editorsPristine=!1,a.selectedEditor=b},a.removeAll=function(){a.currentEditors.splice(0,a.currentEditors.length),a.editorsPristine=!1},a.removeOne=function(){var b=a.currentEditors.indexOf(a.selectedEditor),c=i(a.selectedEditor);a.currentEditors.splice(b,1),a.editorsPristine=!1,a.selectedUser=c},a.abortEditors=function(){a.currentEditors=angular.copy(a.selectedProject.editors),a.setError(!1),a.editorsPristine=!0},a.saveEditors=function(){c.http({action:"update_editors",project:a.selectedProject.name,editors:angular.toJson(a.currentEditors)},d).then(function(b){e(b,a.selectedProject.name)},a.setError)},a.prepare=function(b){c.setNonce(b,d),c.http({action:"get_admin_data"},d).then(e,a.setError)}}]),crwApp.directive("crwOptionClick",function(){return{link:function(a,b,c){b.on("click","option",function(){a.$apply(function(){a.activateGroup(c.crwOptionClick)})})}}}),crwApp.controller("ReviewController",["$scope","$filter","ajaxFactory",function(a,b,c){var d,e="review";a.selectedCrossword={confirmed:null,pending:null},a.activeGroup="confirmed";var f=function(c,d){var e;a.projects=c.projects,d&&(e=a.projects.filter(function(a){return a.name===d})[0]),a.selectedProject=e||b("orderBy")(a.projects,"name")[0],a.setError(!1)};a.deleteCrossword=function(b){var d={which:"delete_crossword",crossword:a.selectedCrossword[b],project:a.selectedProject.name};a.immediateStore.newPromise("actionConfirmation",d).then(function(){c.http({action:"delete_crossword",project:a.selectedProject.name,name:a.selectedCrossword[b]},e).then(function(b){f(b,a.selectedProject.name)})},a.setError)},a.confirm=function(){var d=a.selectedCrossword.pending,g={which:"approve_crossword",crossword:d,project:a.selectedProject.name};a.immediateStore.newPromise("actionConfirmation",g).then(function(){c.http({action:"approve_crossword",project:a.selectedProject.name,name:d},e).then(function(c){f(c,a.selectedProject.name),a.selectedCrossword.confirmed=d,a.selectedCrossword.pending=b("orderBy")(a.selectedProject.pending,"toString()")[0],a.activateGroup("confirmed")},a.setError)},a.setError)},a.activateGroup=function(b){a.activeGroup=b,a.previewCrossword=a.selectedCrossword[b]},a.$watch("selectedProject",function(c){c&&(a.preview&&a.$broadcast("previewProject",c.name,d),angular.forEach(a.selectedCrossword,function(d,e){(!d||c[e].indexOf(d)<0)&&(a.selectedCrossword[e]=b("orderBy")(c[e],"toString()")[0])}))}),a.$watch("preview",function(b){b&&a.selectedProject&&a.$evalAsync(function(b){a.$broadcast("previewProject",a.selectedProject.name,d),a.previewCrossword=a.selectedCrossword[a.activeGroup],a.$broadcast("previewCrossword",a.previewCrossword)})}),a.$watchCollection("selectedCrossword",function(b){a.previewCrossword=b[a.activeGroup]}),a.$watch("previewCrossword",function(b){a.preview&&a.$broadcast("previewCrossword",b)}),a.prepare=function(b,g){d=b,c.setNonce(g,e),c.http({action:"list_projects_and_riddles"},e).then(f,a.setError)}}]),crwApp.config(["$routeProvider","nonces",function(a,b){function c(a){var c=crwBasics.ajaxUrl+"?action=get_option_tab&tab=";return b.settings?c+a+"&_crwnonce="+b.settings:c+"invalid"}a.eagerInstantiationEnabled(!1);var d="";a.when("/capabilities",{templateUrl:function(){return d="/capabilities",c("capabilities")}}).when("/editor",{templateUrl:function(){return d="/editor",c("editor")}}).when("/review",{templateUrl:function(){return d="/review",c("review")}}).otherwise({redirectTo:function(){return d}})}]),crwApp.filter("duration",function(){return function(a){if("number"==typeof a&&a>=0){var b=Math.round(a/100),c=(Math.floor(b%600)/1e3).toFixed(3).split(".")[1];return Math.floor(b/600)+":"+c.substring(0,2)+"."+c.substring(2)}return" "}}),crwApp.factory("time",function(){return{getStamp:function(){return(new Date).getTime()}}}),crwApp.directive("crwTimerElement",["time","$interval",function(a,b){return{restrict:"A",transclude:!0,scope:{timer:"=crwTimerElement"},link:function(c,d,e,f,g){function h(){c.timer.time=a.getStamp()-m,n>0&&c.timer.time>=n&&j()}function i(){l&&(c.$interval.cancel(l),l=void 0),m=null}function j(){"playing"===c.timer.state&&(c.timer.time=a.getStamp()-m,i(),c.timer.state=o?"final":"scored")}function k(){i(),c.timer={countdown:n>0,submitting:o,state:"waiting",time:void 0}}var l,m=null,n=1e3*parseInt(e.countdown,10),o=angular.isDefined(e.submitting);c.$interval=b,c.timer={},c.texts={},angular.element(g()).filter("span").each(function(a,b){var d=angular.element(b);c.texts[d.attr("state")]={alt:d.attr("alt"),title:d.text()}}),c.$on("timerStop",j),c.$on("timerInit",k),c.getState=function(){return"#crw-btn-"+c.timer.state},c.getTime=function(){return Math.abs(n-c.timer.time)},c.getTitle=function(){return c.texts[c.timer.countdown?"down":"up"].title},c.getDisabled=function(){return["waiting","scored"].indexOf(c.timer.state)<0},c.play=function(){"waiting"===c.timer.state?(m=a.getStamp(),c.timer.time=0,c.timer.state="playing",l=c.$interval(h,200)):"scored"===c.timer.state&&(c.timer.state="waiting")},c.$on("$destroy",i)},template:'<svg class="crw-control-button" ng-class="{disabled:getDisabled()}" alt="{{texts[timer.state].alt}}" title="{{texts[timer.state].title}}" ng-click="play()"><use xlink:href="{{getState()}}"/></svg><tt title="{{getTitle()}}">{{getTime() | duration}}</tt>'}}]),crwApp.directive("crwMenu",["$compile",function(a){return{scope:{value:"="},link:function(a,b,c){a.$watch("value",function(c){b.attr("title",a.value.title)})},template:'<span crw-bind-trusted="value.display || value"></span>'}}]),crwApp.constant("combiningRegExp",/^[^\u02B0-\u036F\u064B-\u065F\u1AB0-\u1AFF\u1DC0-\u1DFF][\u02B0-\u036F\u064B-\u065F\u1AB0-\u1AFF\u1DC0-\u1DFF]+$/),crwApp.directive("crwLetterInput",["combiningRegExp",function(a){return{link:function(b,c){var d,e,f="";b.$on("setFocus",function(a,b,g){c[0].focus(),d=b,e=g,f=""}),c.on("keydown",function(a){switch(a.stopPropagation(),a.key){case"Del":case"Delete":case"Backspace":return b.$apply(b.setLetter(null,d,e)),a.preventDefault();case"Left":case"ArrowLeft":return e>0&&b.activate(d,e-1),a.preventDefault();case"Up":case"ArrowUp":return d>0&&b.activate(d-1,e),a.preventDefault();case"Right":case"ArrowRight":return e<b.crosswordData.size.width-1&&b.activate(d,e+1),a.preventDefault();case"Down":case"ArrowDown":return d<b.crosswordData.size.height-1&&b.activate(d+1,e),a.preventDefault()}a.ctrlKey&&a.preventDefault()}),c.on("input",function(g){var h=c.val();a.test(f+h)?f+=h:f=h,b.$apply(b.setLetter(f,d,e)),c.val(null)}),c.on("paste",function(a){a.preventDefault()}),c.on("blur",function(){b.$broadcast("setFocus",-1,-1)})}}}]),crwApp.controller("CrosswordController",["$scope","qStore","basics","crosswordFactory",function(a,b,c,d){function e(b){a.commandList.filter(function(a){return"load"===a.value})[0].group=b}a.crw||(a.crw=d.getCrw()),a.immediateStore||(a.immediateStore=b.addStore()),a.commandState="full",a.highlight=[],a.levelList=a.crw.getLevelList(),a.riddleVisible=!0,a.waitsForData=!0,a.commands={new:"load()",load:"group",update:'save("update")',insert:'save("insert")',reload:"load(loadedName)"},a.prepare=function(b,d,e,f,g){switch(a.crw.setProject(b,d,e,"restricted"===f),f){case"restricted":a.commandState="restricted",delete a.commands.load,delete a.commands.insert;break;case"timer":a.riddleVisible=!1,a.$watch("timer.state",function(b,c){if("playing"===b)a.riddleVisible=!0;else if("scored"===c&&"waiting"===b)a.restart();else if("playing"===c&&"waiting"!==b){a.$broadcast("markingStop");var d=a.timer.submitting?"submitSolution":"solvedCompletely";a.immediateStore.newPromise(d,a.timer.time)}})}a.commandList=Object.keys(a.commands).map(function(a){var b=c.localize(a);return b.value=a,"load"===a&&(b.menu=b.display,b.group=[]),b});var h=a.$on("immediateReady",function(){a.load("restricted"===a.commandState?null:g),h()})},a.$on("cseSelect",function(b,c,d){switch(b.stopPropagation(),c){case"command":a.$evalAsync(a.commands[d]);break;case"command.sub":a.$evalAsync('load("'+d+'")');break;case"load":a.crosswordData&&d===a.loadedName?a.$evalAsync("restart()"):a.$evalAsync('load("'+d+'")');break;case"level":var e=a.crw.testDirection(),f=a.crosswordData.level;if(!(1&d)&&e.length){a.setHighlight(e);var g={count:e.length,level:d};a.immediateStore.newPromise("invalidDirections",g).then(function(){e.forEach(function(b){a.crw.deleteWord(b,"words")})},function(){a.$evalAsync("crosswordData.level="+f)}).finally(function(){a.setHighlight([])})}}}),a.$on("previewProject",function(b,c,d){a.crw.setProject(c,d)}),a.wordsToArray=function(a){var b=[];return angular.forEach(a,function(a){b.push(a)}),b};var f=function(){"full"===a.commandState&&(a.namesInProject=a.crw.getNamesList(),e(a.namesInProject)),a.loadedName=a.crosswordData.name,a.setHighlight([])},g=function(){a.crosswordData=a.crw.getCrosswordData(),a.levelList=a.crw.getLevelList(),a.count=a.crw.getCount(),f(),"object"==typeof a.timer&&(a.riddleVisible=!1,a.$broadcast("timerInit")),a.waitsForData=!1};a.setHighlight=function(b){a.highlight=b},a.load=function(b){a.loadError=null,b||"string"==typeof b?(a.waitsForData=!0,a.crw.loadCrosswordData(b).then(g,function(b){a.loadError=b})):(a.waitsForData=!1,a.crw.loadDefault(),g())},a.$on("previewCrossword",function(b,c){a.load(c)}),a.restart=function(){if(a.timer){if(a.timer.submitting)return;a.riddleVisible=!1,a.$broadcast("timerInit")}a.crw.getLevelRestriction("sol")||Object.keys(a.crosswordData.solution).forEach(function(b){delete a.crosswordData.solution[b]}),angular.forEach(a.crosswordData.words,function(a){a.solved=!1}),a.count.solution=0},a.$watch("count.solution",function(b){b>0&&b===a.count.words&&(a.timer?a.$broadcast("timerStop"):a.immediateStore.newPromise("solvedCompletely"))}),a.save=function(b){a.crosswordData.name||(b="insert"),a.immediateStore.newPromise("saveCrossword",b).then(f)},a.randomize=function(){a.crw.randomizeEmptyFields()},a.empty=function(){a.crw.emptyAllFields()},a.activate=function(b,c){a.$broadcast("setFocus",b,c)},a.setLetter=function(b,d,e){null===b?a.crosswordData.table[d][e].letter=null:c.letterRegEx.test(b)&&(a.crosswordData.table[d][e].letter=c.normalizeLetter(b))}}]),crwApp.directive("crwGridsize",["basics",function(a){return{link:function(b,c){function d(b){var c={};return angular.forEach(b,function(b,d){c[d]=b*a.fieldSize}),c}var e=c.find("pattern"),f=c.find("clipPath rect"),g=["M",a.fieldShift,a.fieldSize,"V",a.fieldShift,"H",a.fieldSize].join(" ");e.attr({x:-a.fieldShift,y:-a.fieldShift,width:a.fieldSize,height:a.fieldSize}),e.children("path").attr("d",g),b.sizeBorder=function(a){f.attr(d(a))},b.$watch("crosswordData.size",function(a){if(a){var b=d({x:0,y:0,width:a.width,height:a.height});c.attr("viewBox",jQuery.map(b,angular.identity).join(" ")),f.attr(b),delete b.x,delete b.y,c.css(b)}})}}}]),crwApp.directive("crwGridhandle",["$document","basics",function(a,b){return{scope:!0,link:function(c,d,e){function f(){var a,f,g=[0,0],h=angular.copy(c.crosswordData.size);h.x=h.y=0;var m={height:"60%",width:"60%"};switch(e.crwGridhandle){case"top":a=Math.ceil((j.y-i.y)/b.fieldSize),h.y=a,h.height=f=c.crosswordData.size.height-a,m.height=b.handleWidth,g[1]=b.handleOffset-b.handleWidth,c.moving?(m.height+=-j.y+i.y+a*b.fieldSize,g[1]+=j.y-i.y):g[1]+=a*b.fieldSize;break;case"bottom":a=Math.floor((j.y-i.y)/b.fieldSize),h.height=f=c.crosswordData.size.height+a,m.height=b.handleWidth,c.moving&&(m.height+=j.y-i.y-a*b.fieldSize),g[1]=h.height*b.fieldSize-b.handleOffset;break;case"left":a=Math.ceil((j.x-i.x)/b.fieldSize),h.x=a,h.width=f=c.crosswordData.size.width-a,m.width=b.handleWidth,g[0]=b.handleOffset-b.handleWidth,c.moving?(m.width+=-j.x+i.x+a*b.fieldSize,g[0]+=j.x-i.x):g[0]+=a*b.fieldSize;break;case"right":a=Math.floor((j.x-i.x)/b.fieldSize),h.width=f=c.crosswordData.size.width+a,m.width=b.handleWidth,c.moving&&(m.width+=j.x-i.x-a*b.fieldSize),g[0]=h.width*b.fieldSize-b.handleOffset}return f>2?(d.attr("transform","translate("+g.join(" ")+")"),l.attr(m),a!==k&&(k=a,c.sizeBorder(h)),a):k}function g(a){var b=h.getScreenCTM().inverse();c.moving||(i.x=a.clientX,i.y=a.clientY,i=i.matrixTransform(b),c.moving=!0),j.x=a.clientX,j.y=a.clientY,j=j.matrixTransform(b),f()}var h=d[0].ownerSVGElement,i=h.createSVGPoint(),j=h.createSVGPoint();i.x=i.y=j.x=j.y=0;var k=0,l=d.children(".gridhandle"),m=l.children("svg");switch(c.moving=!1,c.$watch("crosswordData.size",f),e.crwGridhandle){case"bottom":m.children().attr("transform","translate(0 -"+b.handleWidth+")");case"top":m.attr("height",b.handleWidth);break;case"right":m.children().attr("transform","translate(-"+b.handleWidth+" 0)");case"left":m.attr("width",b.handleWidth)}c.startResize=function(){a.on("mousemove",g)},c.stopResize=function(){a.off("mousemove",g),c.moving=!1;var b=f();i.x=i.y=j.x=j.y=0,b&&c.testResize(e.crwGridhandle,b).then(angular.noop,f)}}}}]),crwApp.directive("crwGridfield",["basics",function(a){return{link:function(b,c){var d=c.children(".gridlight"),e=c.children(".gridletter");d.attr({width:a.fieldSize-2*(a.fieldShift+1),height:a.fieldSize-2*(a.fieldShift+1)}),"build"===b.mode&&(c.on("click",function(a){a.preventDefault(),b.$apply("activate(line, column)")}),b.$on("setFocus",function(a,c,e){d.toggleClass("active",c===b.line&&e===b.column)})),"preview"!==b.mode&&(c.on("mouseenter",function(){b.$apply("intoField(line, column)")}),c.on("mouseleave",function(){b.$apply("outofField(line, column)")})),b.$watchGroup(["line","column"],function(b){b&&(d.attr({x:a.fieldSize*b[1]+a.fieldShift+1,y:a.fieldSize*b[0]+a.fieldShift+1}),e.attr({x:a.fieldSize*b[1]+a.fieldSize/2,y:a.fieldSize*b[0]+a.fieldSize/2}))})}}}]),crwApp.directive("crwGridline",["basics",function(a){return{link:function(b,c,d){var e=d.crwGridline+".start",f=d.crwGridline+".stop";b.$watchGroup([e,f],function(b){b[0]&&b[1]&&c.attr({x1:a.fieldSize*b[0].x+a.fieldSize/2,y1:a.fieldSize*b[0].y+a.fieldSize/2,x2:a.fieldSize*b[1].x+a.fieldSize/2,y2:a.fieldSize*b[1].y+a.fieldSize/2})})}}}]),crwApp.directive("crwCatchMouse",["$document",function(a){return{link:function(b,c,d){var e=function(c){angular.isDefined(d.preventDefault)&&c.preventDefault(),a.bind("mouseup",f),b[d.down]()},f=function(c){angular.isDefined(d.preventDefault)&&c.preventDefault(),a.unbind("mouseup",f),b.$apply(b[d.up]())};c.bind("mousedown",e),c.on("$destroy",function(){c.unbind("mousedown",e),a.unbind("mouseup",f)})}}}]),crwApp.directive("crwIndexChecker",function(){return{link:function(a,b,c){a.$watch("$index",function(b){a[c.crwIndexChecker]=b})}}}),crwApp.controller("GridController",["$scope","$q","basics",function(a,b,c){function d(b){var d,e=a.currentMarking.start.x-b.x,f=a.currentMarking.start.y-b.y;return a.crw.getLevelRestriction("dir")?(d=c.textIsLTR?0===f&&e<=0:0===f&&e>=0,0===e&&f<=0||d):Math.abs(e)===Math.abs(f)||0===e||0===f}function e(){a.isMarking=!1,a.currentMarking={ID:a.crw.getHighId()}}function f(){a.isMarking&&("solve"===a.mode&&a.crw.deleteWord(a.currentMarking.ID,"solution"),a.isMarking=!1)}a.setMode=function(b){a.mode=b,e()},a.$watch("crosswordData.name",e),a.testResize=function(c,d){var e=a.crw.testWordBoundaries(c,d);return e.length?(a.setHighlight(e),a.immediateStore.newPromise("invalidWords",e).then(function(){a.crw.changeSize(c,d,e)}).finally(function(){a.setHighlight([])})):(a.crw.changeSize(c,d,e),b.resolve())},a.startMark=function(){a.isMarking=!a.timer||"playing"===a.timer.state,a.currentMarking={ID:a.currentMarking.ID+1},a.currentMarking.color="build"===a.mode?a.crw.randomColor():"grey"},a.$on("markingStop",f),a.stopMark=function(){var b;a.isMarking&&(angular.equals(a.currentMarking.start,a.currentMarking.stop)||("build"===a.mode?b=a.crw.setWord(a.currentMarking):(b=a.crw.probeWord(a.currentMarking),b.solved?a.count.solution++:null===b.solved?f():(a.setHighlight([b.ID]),a.immediateStore.newPromise("falseWord",b.fields).then(function(){a.crw.deleteWord(a.currentMarking.ID,"solution"),a.setHighlight([])})))),a.isMarking=!1)},a.intoField=function(b,c){var e={x:c,y:b};a.isMarking&&a.currentMarking.start&&d(e)&&(a.currentMarking.stop=e)},a.outofField=function(b,c){a.isMarking&&!a.currentMarking.start&&(a.currentMarking.start=a.currentMarking.stop={x:c,y:b})},a.getId=function(a,b){return a+b}}]),crwApp.directive("colorSelect",["basics",function(a){return{scope:{value:"="},link:function(b,c,d){b.localize=a.localize},template:'<svg title="{{localize(value)}}"  class="crw-marker" ng-class="value"><use xlink:href="#crw-bullet"/></svg>'}}]),crwApp.filter("joinWord",function(){return function(a){return a.reduce(function(a,b){return a+(b.word.letter||"_")},"")}}),crwApp.controller("EntryController",["$scope","$filter","basics",function(a,b,c){a.colors=c.colors,a.textIsLTR=c.textIsLTR,a.isHighlighted=function(){for(var b=0;b<a.highlight.length;b++)if(a.highlight[b]===a.word.ID)return!0;return!1},a.deleteWord=function(b){a.crw.deleteWord(b,"words")},a.localize=c.localize,a.$on("select",function(a){a.stopPropagation()})}]),crwApp.factory("qStore",["$q",function(a){function b(){var b={};this.register=function(a,c){b[a]||(b[a]=[]),b[a].push(c)},this.newPromise=function(c,d){var e=a.defer();return b[c]&&b[c].forEach(function(a){a(e,d)}),e.promise}}return{addStore:function(){return new b}}}]),crwApp.directive("crwAddParsers",function(){return{require:"ngModel",link:function(a,b,c,d){var e=/\s+/,f=c.crwAddParsers.split(e);if(f.indexOf("unique")>=0){var g=c.crwUnique.split(e);d.$parsers.unshift(function(b){if(void 0===b)return b;var c,e,f=b;for(e=0;e<g.length;e++)c=a.$eval(g[e]),Array.isArray(c)?c.indexOf(b)>=0&&(f=void 0):"object"!=typeof c?"string"!=typeof c||c!==b||(f=void 0):c.hasOwnProperty(b)&&(f=void 0);return d.$setValidity("unique",void 0!==f),f})}f.indexOf("sane")>=0&&d.$parsers.unshift(function(a){return a=a.replace(e," "),a.replace(/<|%[a-f0-9]{2}/,"")===a?(d.$setValidity("sane",!0),a):void d.$setValidity("sane",!1)})}}}),crwApp.directive("crwHasPassword",function(){return{link:function(a,b,c,d){b.find("input[type=submit]").on("click",function(){a.password=null}),b.on("$destroy",function(){b.find("[required]").attr("required",null)})}}}),crwApp.controller("ImmediateController",["$scope","$sce",function(a,b){function c(b){a.progress=0,a.saveError=b.error,a.saveDebug=b.debug}function d(b){a.message={which:"solved_completely",buttons:{ok:!0}},a.count.words>a.count.solution&&(a.message.which="solved_incomplete",a.message.words=a.count.words,a.message.solution=a.count.solution),a.message.time=b||"false"}var e;a.immediate=null,a.finish=function(b){a.saveError=void 0,a.saveDebug=void 0,a.immediate=null,b?e.resolve():e.reject()},a.immediateStore.register("invalidWords",function(b,c){e=b,a.message={which:"invalid_words",count:c.length,buttons:{delete:!0,abort:!0}},a.immediate="dialogue"}),a.immediateStore.register("invalidDirections",function(b,c){e=b,a.message={which:"invalid_directions",count:c.count,level:c.level,buttons:{delete:!0,abort:!0}},a.immediate="dialogue"}),a.immediateStore.register("saveCrossword",function(b,c){e=b,a.immediate="save_crossword",a.action=c}),a.upload=function(b,d){a.crw.saveCrosswordData("update"===a.action?a.loadedName:a.crosswordData.name,a.loadedName===a.crosswordData.name?"update":a.action,b,d).then(a.finish,c)},a.immediateStore.register("falseWord",function(b,c){e=b,a.message={which:"false_word",word:c,buttons:{delete:!0}},a.immediate="dialogue"}),a.immediateStore.register("solvedCompletely",function(b,c){e=b,d(c),a.immediate="dialogue"}),a.immediateStore.register("submitSolution",function(b,c){e=b,d(c),a.progress=0,a.immediate="submit_solution"}),a.submit=function(d,e){switch(a.progress){case 0:a.saveError=void 0,a.saveDebug=void 0,a.progress=1,a.crw.submitSolution((a.message.time/1e3).toFixed(1),d,e).then(function(c){c.length?(a.progress=2,a.message.feedback=b.trustAsHtml(c)):a.finish(!0)},c);break;case 2:a.finish(!0)}},a.immediateStore.register("actionConfirmation",function(b,c){e=b,a.message=angular.extend(c,{buttons:{ok:!0,abort:!0}}),a.immediate="dialogue"}),a.$emit("immediateReady")}]);